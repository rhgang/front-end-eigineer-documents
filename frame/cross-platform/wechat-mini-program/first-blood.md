从2017年初小程序发布，一开始小程序不温不火。今年年初的时候微信团队推出小游戏，“跳一跳”让小程序又进入大众的眼帘，从游戏中的好友排行榜这一点，我就很佩服微信的产品经理深谙人性。今年四月份的时候，教育部、全国计算机高等教育研究会和腾讯微信事业部联合举办了第一届微信小程序开发大赛，看起来像是微信想在高校的学生群体中做一个推广，微信团队拿出几十万的经费，让全国高校学生花时间和心思做出各种产品，还能顺势做一波宣传，这种事情何乐而不为？我在年初的时候开发了一个微信小程序：在乎生活，体验了小程序的开发体系，同时对小程序的技术实现和应用场景也有了一定的理解，在这里做一个总结。

## 一、什么样的产品适合接入小程序？
16年9月，微信应用号以“小程序”的名义发布，张小龙给小程序这样定义：**小程序是一种不用下载安装即可使用的应用，它实现了应用“触手可及”的梦想，用户扫一扫或搜一搜即可打开应用。也体现了“用完即走”的理念，用户不用担心安装应用太多的问题。应用将无处不在，随时可用，但又无需安装和卸载**。

微信小程序的确是应用开发模式的一大创新，为企业和开发者带来许多便利。开发者使用微信提供的微信开发者工具编写代码，无需考虑跨平台兼容性的问题。企业开发小程序，可以大大降低开发成本和维护周期，再结合微信这个庞大的流量入口，可以给企业带来不少红利。但是小程序并不是适合所有的应用场景的，所以应用的负责人不得不考虑这个问题：**我们的产品要不要开发小程序版本**？

一般我们的应用有Native App、Web App、Hybrid App、小程序：

>>>
>**Native App**开发成本比较大，不同的操作系统都需要单独开发一套，每次功能的更新都需要发布新的版本。但是Native App可以很好的调用硬件设备的功能，能够实现酷炫的交互效果。
>
>**Web App**使用Web技术开发，运行在浏览器环境下，Web App开发成本低、周期短、使用方便、维护简单，可能需要考虑浏览器的兼容性，但是不用考虑操作系统的兼容性，但是性能体验较差，不支持调用硬件设备。
>
>HTML5的发展让**Hybrid App**技术得以诞生，Hybrid App具有跨平台的优势，降低了移动应用的开发成本。底层使用Native容作为容器，业务逻辑均用H5实现，H5和Native之间通过JsBridge进行通信。
>
>**小程序**可以理解为特殊的Hybrid App，小程序运行在微信的环境下，使用微信自定义的DSL进行开发，运行速度快，可以调用微信的提供开放接口，如微信支付功能，甚至可以通过微信接口调用GPS定位、录音、录制视频等硬件设备功能。小程序的核心点在于：**轻便、无需下载安装、用完即走**。更新版本只需要提交微信审核即可，不需要提交到APP Store。

考虑到微信小程序的特点，我们可以从两个因素入手去分析：使用频率和重要性。我们可以将生活中的常见应用分为四大类：

>>
>**高频重要**：
* 入口类：百度；
* 工具类：地图、浏览器、输入法；
* 金融类：支付宝；
* 社交类：微博、脉脉；
* 教育类：慕课网、TED。
>>
>**高频不重要**：
* 娱乐类：网易云音乐、优酷视频；
* 内容类：知乎、豆瓣；
* 工具类：美图秀秀；
* 游戏类：休闲游戏、象棋、桌球；
* 社区类：贴吧。
>>
>**低频重要**：
* 生活服务：58同城、滴滴打车；
* O2O类：家政服务；
* 旅游类：去哪儿、携程；
* 其他：摩拜单车。
>>
>**低频不重要**：
* 小众社区
>>

高频重要的应用一般对交互要求比较高，数据量也比较大，微信小程序**适合简单的小应用**，这类大型应用不应该接入小程序；高频不重要的应用可以考虑从小程序中引入新用户，然后引导至自己的产品中，目前“知乎”、“豆瓣”等小程序也都是这种机制；**低频重要的应用是一定要考虑接入小程序的**，这一类应用在生活中使用并不频繁，但是总有时候会需要，比如购票软件，一年可能就用几次，但是又不能少了它，这一类服务型的应用开发小程序就能够解决用户的需要。

在几年前的移动互联网热潮，一个大众创业、万众创新的时代，大家都在调侃：“万事俱备，就差一个程序员了”。虽然是一个笑话，但是也可以看出，对于初创公司来说，开发一个应用成本还是挺高的，所以初创型企业可以考虑用小程序来开发自己的产品，从而对产品进行快速试错。7月26号上市的“社交电商”拼多多一开始就是利用小程序的流量入口来增长用户，用户在拼多多小程序中选购商品，然后让分享给微信好友帮忙砍价，小程序给拼多多带来了快速的用户增长。

用我大学里系主任的一句口头禅来说：“甘蔗没有两头甜”，小程序也存在着不足：
>
>1、小程序有大小限制，所以不适合复杂的应用；
>
>2、小程序也无法实现Native App具有的所有功能；
>
>3、小程序可以获取的用户数据有限；
>
>4、小程序没有分发渠道，没有类似App Store排行榜的功能，需要用户主动寻找小程序。

二、小程序的技术架构
小程序在技术架构上分为**视图层和逻辑层**。

**视图层**：由微信定义的DSL：WXML、WXSS共同实现，使用WebView渲染。WXML是一种模板语言，类似于JSX。WXML会被编译成JS，插入数据后生成虚拟DOM，最终生成真实DOM，在WebView中渲染。WXSS具有CSS大部分特性，同时对CSS进行了扩充，新增了自定义尺寸单位“rpx”，“rpx”可以根据设备屏幕进行自适应调整。微信提供了小程序量身定制的基础组件样式库，还支持`<canvas/>、 <video/>、 <map/> 、<textarea/>`等Navtive Component。

**逻辑层**：使用JSCore运行。小程序中有一个唯一的实例，在App.js中定义，每一个页面也都有一个Page实例，整个应用存在生命周期（如下图红色方框内所示），每个页面也有自己的生命周期（如下图蓝色方框内所示）。

<div align=center>

![infa](./../imgs/wechat-mini-program/architecture.jpeg)

</div>

交互通过Native层的Js Bridge来实现，当用户进行操作触发Event，通过Js Bridge通知逻辑层，逻辑层执行对应逻辑后将数据通过Js Bridge返回给视图层，视图层执行相应操作。

<div align=center>

![infa](./../imgs/wechat-mini-program/4.jpeg)

</div>

小程序启动时，会从CDN拉取小程序的完整包，然后在微信内部进行解析。


<div align=center>

![infa](./../imgs/wechat-mini-program/5.jpeg)

</div>

小程序在不同平台分别运行在不同的环境上，在iOS中运行在JSCore上，Android中运行在腾讯的X5内核中，微信开发者工具使用nwjs开发，运行在Chrome内核上。微信开发者工具确实方便，解决了开发者在开发项目时一定会遇到的**环境配置问题**，开发者工具也解决了小程序发布和部署的问题，开发者只需要在工具中提交代码即可。只要有React、Vue等前端框架的开发经验，小程序上手是很快的。

Web技术离不开渲染的性能问题，小程序在提高渲染性能上对PageFrame做了下面的这些优化：
>
>1、Native预先加载额外一个WebView。
>
>2、当打开指定页面时，无需请求额外资源，直接渲染。
>
>3、重渲染使用Virtual DOM减少开销，采用diff算法局部更新。
>
>4、小程序的Javascript通过X5的JSCore来解析，由X5基于Mobile Chrome 37内核来渲染。

最后不得不提的一点是，小程序提供了强大的后台管理功能。后台系统可以对你的产品进行数据分析，包括订单分析、用户分析、用户群体画像、实时分析。大量的数据分析可以为企业决策提供参考，为企业带来不少便利。

小程序在微信生态中的价值，更多的是体现在业务上，而不是技术上，小程序给应用的业务模式带来突破，当然在技术上也给人带来不少新的思路。